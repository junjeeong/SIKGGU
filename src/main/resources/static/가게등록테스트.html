<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sikggu API 테스트 - 사장님/가게 등록</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      border-bottom: 2px solid #ccc;
      padding-bottom: 10px;
      margin-top: 20px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input[type="text"], input[type="password"] {
      width: 95%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    select {
      width: 98%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }

    button:hover {
      background-color: #0056b3;
    }

    pre {
      background-color: #eee;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>API 테스트 시뮬레이터</h1>
  <p>Console 탭을 열어 API 호출 결과를 확인하세요. (F12)</p>
  <hr>

  <h2>1. 사장님 회원가입 (Sign Up)</h2>
  <form id="signUpForm">
    <label for="signUpEmail">이메일:</label>
    <input type="text" id="signUpEmail" value="store_test_new@example.com" required>
    <label for="signUpPassword">비밀번호:</label>
    <input type="password" id="signUpPassword" value="Password123!" required>
    <label for="signUpNickname">닉네임:</label>
    <input type="text" id="signUpNickname" value="테스트사장님" required>
    <label for="signUpPhone">전화번호:</label>
    <input type="text" id="signUpPhone" value="010-9876-5432" required>
    <label for="signUpRole">역할 (Role):</label>
    <select id="signUpRole" required>
      <option value="STORE">STORE (사장님)</option>
      <option value="USER">USER (일반 사용자)</option>
    </select>
    <button type="submit">회원가입 요청</button>
  </form>
  <p>결과: <span id="signUpResult" class="error">대기 중...</span></p>
  <pre id="signUpResponsePre" style="max-height: 150px; overflow-y: auto;"></pre>

  <h2>2. 로그인 및 토큰 획득 (Sign In)</h2>
  <form id="signInForm">
    <label for="signInEmail">이메일:</label>
    <input type="text" id="signInEmail" value="store_test_new@example.com" required>
    <label for="signInPassword">비밀번호:</label>
    <input type="password" id="signInPassword" value="Password123!" required>
    <label for="signInRole">역할 (Role):</label>
    <select id="signInRole" required>
      <option value="STORE">STORE (사장님)</option>
      <option value="USER">USER (일반 사용자)</option>
    </select>
    <button type="submit">로그인 요청</button>
  </form>
  <p>토큰: <span id="tokenDisplay" class="error">토큰 없음</span></p>
  <pre id="signInResponsePre" style="max-height: 150px; overflow-y: auto;"></pre>

  <h2>3. 가게 등록 (Store Creation)</h2>
  <form id="createStoreForm">
    <label>가게 이름:</label><input type="text" id="storeName" value="테스트반찬가게" required>
    <label>전화번호:</label><input type="text" id="storePhone" value="02-1234-5678" required>
    <label>주소:</label><input type="text" id="storeAddress" value="서울시 강남구" required>
    <label>위도 (Lat):</label><input type="text" id="storeLat" value="37.51" required>
    <label>경도 (Lng):</label><input type="text" id="storeLng" value="127.01" required>
    <button type="submit">가게 등록 요청 (토큰 필요)</button>
  </form>
  <p>결과: <span id="storeResult" class="error">대기 중...</span></p>
  <pre id="storeResponsePre" style="max-height: 150px; overflow-y: auto;"></pre>
</div>

<script>
  const BASE_URL = "http://localhost:8080/api/v1"; // 테스트를 위해 명시적으로 포트 지정
  let globalToken = null;

  // --- 헬퍼 함수 ---
  async function apiRequest(endpoint, method, body, requiresAuth = false) {
    const headers = {
      'Content-Type': 'application/json'
    };

    if (requiresAuth && globalToken) {
      headers['Authorization'] = `Bearer ${globalToken}`;
    } else if (requiresAuth && !globalToken) {
      throw {type: 'AuthError', message: `[${endpoint}] 인증 실패: 토큰이 없습니다. 먼저 로그인하세요.`};
    }

    try {
      const response = await fetch(`${BASE_URL}${endpoint}`, {
        method: method,
        headers: headers,
        body: body ? JSON.stringify(body) : null
      });

      if (!response.ok) {
        const contentType = response.headers.get("content-type");
        let errorData = {
          code: response.status,
          status: response.statusText,
          message: `HTTP Status: ${response.status} ${response.statusText}`,
          details: null
        };

        if (contentType && contentType.includes("application/json")) {
          // JSON 에러 응답 파싱 시도
          try {
            errorData.details = await response.json();
            errorData.message = errorData.details.message || errorData.message;
          } catch (e) {
            errorData.details = {error: '에러 응답 본문 JSON 파싱 실패'};
          }
        } else {
          // JSON이 아닐 경우 텍스트로 처리 (403 Forbidden 등)
          errorData.details = {text: await response.text().catch(() => '응답 본문 없음')};
        }

        console.error(`[${endpoint}] API 요청 실패:`, response.status, errorData);
        throw {type: 'ApiError', status: response.status, responseData: errorData};
      }

      if (response.status === 204) {
        return {message: "No Content (Success)"};
      }

      // 응답 본문이 없을 경우 처리
      if (response.headers.get("content-length") === "0" || response.status === 201
          && response.headers.get("content-length") === null) {
        return {message: `Status ${response.status} Success: Empty body`};
      }

      return await response.json();

    } catch (error) {
      if (error.type) {
        throw error; // AuthError, ApiError는 그대로 전파
      }
      console.error(`[${endpoint}] 네트워크 또는 처리 오류:`, error);
      throw {type: 'NetworkError', message: error.message || '네트워크 오류 발생'};
    }
  }

  // --- 1. 회원가입 ---
  document.getElementById('signUpForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const signUpData = {
      email: document.getElementById('signUpEmail').value,
      password: document.getElementById('signUpPassword').value,
      nickname: document.getElementById('signUpNickname').value,
      phoneNumber: document.getElementById('signUpPhone').value,
      role: document.getElementById('signUpRole').value
    };

    const resultSpan = document.getElementById('signUpResult');
    const responsePre = document.getElementById('signUpResponsePre');

    resultSpan.textContent = '요청 중...';
    resultSpan.className = 'error';
    responsePre.textContent = '...';

    try {
      const data = await apiRequest('/auth/sign-up', 'POST', signUpData);
      resultSpan.textContent = `회원가입 성공. User ID: ${data.userId}`;
      resultSpan.className = 'success';
      responsePre.textContent = JSON.stringify(data, null, 2);
      console.log("회원가입 성공:", data);
    } catch (e) {
      resultSpan.textContent = `회원가입 실패 (Status: ${e.status || 'N/A'})`;
      resultSpan.className = 'error';
      if (e.responseData) {
        responsePre.textContent = `Error Response:\n${JSON.stringify(e.responseData, null, 2)}`;
      } else {
        responsePre.textContent = `Error: ${e.message || '알 수 없는 오류'}`;
      }
    }
  });

  // --- 2. 로그인 ---
  document.getElementById('signInForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const signInData = {
      email: document.getElementById('signInEmail').value,
      password: document.getElementById('signInPassword').value,
      role: document.getElementById('signInRole').value
    };

    const tokenDisplay = document.getElementById('tokenDisplay');
    const responsePre = document.getElementById('signInResponsePre');

    tokenDisplay.textContent = '요청 중...';
    tokenDisplay.className = 'error';
    responsePre.textContent = '...';

    try {
      const data = await apiRequest('/auth/sign-in', 'POST', signInData);
      globalToken = data.accessToken;
      tokenDisplay.textContent = `로그인 성공! Token (앞 10글자): ${globalToken.substring(0, 10)}...`;
      tokenDisplay.className = 'success';
      responsePre.textContent = JSON.stringify(data, null, 2);
      console.log("로그인 성공. 토큰:", data.accessToken);
    } catch (e) {
      tokenDisplay.textContent = `로그인 실패 (Status: ${e.status || 'N/A'})`;
      globalToken = null;
      tokenDisplay.className = 'error';
      if (e.responseData) {
        responsePre.textContent = `Error Response:\n${JSON.stringify(e.responseData, null, 2)}`;
      } else {
        responsePre.textContent = `Error: ${e.message || '알 수 없는 오류'}`;
      }
    }
  });

  // --- 3. 가게 등록 ---
  document.getElementById('createStoreForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const storeData = {
      name: document.getElementById('storeName').value,
      phoneNumber: document.getElementById('storePhone').value,
      address: document.getElementById('storeAddress').value,
      latitude: parseFloat(document.getElementById('storeLat').value),
      longitude: parseFloat(document.getElementById('storeLng').value)
    };

    const resultSpan = document.getElementById('storeResult');
    const responsePre = document.getElementById('storeResponsePre');

    resultSpan.textContent = '요청 중...';
    resultSpan.className = 'error';
    responsePre.textContent = '...';

    try {
      const data = await apiRequest('/stores', 'POST', storeData, true); // true: 인증 필요

      resultSpan.textContent = `가게 등록 성공! (HTTP ${data.message.includes('No Content') ? '204'
          : '201'})`;
      resultSpan.className = 'success';
      responsePre.textContent = JSON.stringify(data, null, 2);
      console.log("가게 등록 성공:", data);

    } catch (e) {
      resultSpan.textContent = `가게 등록 실패 (Status: ${e.status || 'N/A'})`;
      resultSpan.className = 'error';
      if (e.type === 'AuthError') {
        responsePre.textContent = `Error: ${e.message}`;
      } else if (e.responseData) {
        responsePre.textContent = `Error Response:\n${JSON.stringify(e.responseData, null, 2)}`;
      } else {
        responsePre.textContent = `Error: ${e.message || '알 수 없는 오류'}`;
      }
    }
  });
</script>

</body>
</html>