<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sikggu API í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: sans-serif;
      line-height: 1.6;
      padding: 20px;
      background-color: #f4f4f9;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      border-bottom: 2px solid #ccc;
      padding-bottom: 10px;
      margin-top: 20px;
      color: #333;
    }

    .api-section {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"], input[type="password"], input[type="number"] {
      width: calc(100% - 12px);
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      background-color: #5cb85c;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      margin-right: 5px;
    }

    button:hover {
      background-color: #4cae4c;
    }

    pre {
      background-color: #eee;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .warning {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ›’ Sikggu API Public í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
  <p class="warning">
    â€» ì¤‘ìš”: API í˜¸ì¶œ ì „ì— **[ë¡œê·¸ì¸ & í† í° ì €ì¥]**ì„ ë¨¼ì € ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
  </p>

  <div class="api-section">
    <h2>ğŸ”‘ 1. íšŒì›ê°€ì… ë° ë¡œê·¸ì¸</h2>
    <div id="auth-inputs">
      <label for="regEmail">ì´ë©”ì¼:</label>
      <input type="text" id="regEmail" value="testuser@example.com">
      <label for="regPassword">ë¹„ë°€ë²ˆí˜¸:</label>
      <input type="password" id="regPassword" value="testpassword1234">
      <label for="regNickname">ë‹‰ë„¤ì„:</label>
      <input type="text" id="regNickname" value="í…ŒìŠ¤íŠ¸ìœ ì €">
      <label for="regPhoneNumber">ì „í™”ë²ˆí˜¸:</label>
      <input type="text" id="regPhoneNumber" value="010-1234-5678">
      <label for="regRole">ì—­í•  (USER/STORE):</label>
      <input type="text" id="regRole" value="USER" placeholder="USER ë˜ëŠ” STORE">
    </div>

    <div style="margin-top: 10px;">
      <button onclick="registerUser()">íšŒì›ê°€ì…</button>
      <button onclick="loginAndSaveToken()">ë¡œê·¸ì¸ & í† í° ì €ì¥</button>
    </div>

    <h3 style="margin-top: 15px;">ë‚´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì£¼ë³€ ì¡°íšŒë¥¼ ìœ„í•´ í•„ìˆ˜)</h3>
    <label for="latitude">ìœ„ë„ (Latitude):</label>
    <input type="number" id="latitude" step="0.000001" value="37.5665">
    <label for="longitude">ê²½ë„ (Longitude):</label>
    <input type="number" id="longitude" step="0.000001" value="126.9780">
    <button onclick="updateUserInfo()">ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸</button>

    <h3 style="margin-top: 15px;">í˜„ì¬ í† í° ìƒíƒœ</h3>
    <pre id="tokenStatus">í† í°ì´ ì—†ìŠµë‹ˆë‹¤.</pre>
  </div>

  <div class="api-section">
    <h2>ğŸ  2. ì£¼ë³€ ë§ˆíŠ¸ ì¡°íšŒ (GET /api/v1/stores)</h2>
    <p>ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜(ìœ„ë„/ê²½ë„)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë³€ ë§ˆíŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. **(USER ê¶Œí•œ í•„ìš”)**</p>
    <button onclick="getNearbyStores()">API í˜¸ì¶œ</button>
    <pre id="nearbyStoresResponse"></pre>
  </div>

  <div class="api-section">
    <h2>ğŸ›’ 3. íŠ¹ì • ë§ˆíŠ¸ì˜ ìƒí’ˆ ì¡°íšŒ (GET /api/v1/sale-items/{storeId})</h2>
    <label for="inputStoreId">ì¡°íšŒí•  ë§ˆíŠ¸ ID (Store ID):</label>
    <input type="text" id="inputStoreId" placeholder="ì£¼ë³€ ë§ˆíŠ¸ ì¡°íšŒ ê²°ê³¼ì—ì„œ í™•ì¸ í›„ ì…ë ¥">
    <button onclick="getProductsByStore()">API í˜¸ì¶œ</button>
    <pre id="productsByStoreResponse"></pre>
  </div>

  <div class="api-section">
    <h2>ğŸ“¦ 4. ì£¼ë³€ ìƒí’ˆ ì¡°íšŒ (GET /api/v1/sale-items/nearby)</h2>
    <p>ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë³€ì˜ ìƒí’ˆë“¤ì„ ì¡°íšŒí•©ë‹ˆë‹¤. **(USER ê¶Œí•œ í•„ìš”)**</p>
    <button onclick="getNearbySaleItems()">API í˜¸ì¶œ</button>
    <pre id="nearbySaleItemsResponse"></pre>
  </div>
</div>

<script>
  const BASE_URL = 'http://localhost:8080/api/v1';
  const TOKEN_KEY = 'jwtToken';

  function getToken() {
    return localStorage.getItem(TOKEN_KEY);
  }

  function updateTokenStatus() {
    const token = getToken();
    document.getElementById('tokenStatus').textContent = token ? `í† í° ì €ì¥ë¨: ${token.substring(0,
        30)}...` : 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤.';
  }

  async function apiCall(endpoint, method = 'GET', body = null) {
    const token = getToken();
    if (!token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € [ë¡œê·¸ì¸ & í† í° ì €ì¥]ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return null;
    }

    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    };

    const config = {
      method: method,
      headers: headers
    };

    if (body && (method === 'POST' || method === 'PATCH')) {
      config.body = JSON.stringify(body);
    }

    try {
      const response = await fetch(BASE_URL + endpoint, config);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || `API í˜¸ì¶œ ì‹¤íŒ¨ (Status: ${response.status})`);
      }
      return data;

    } catch (error) {
      console.error(`Error calling ${endpoint}:`, error);
      return {error: true, message: error.message || 'API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'};
    }
  }

  // ===================================================
  // 1. íšŒì›ê°€ì… ë° ë¡œê·¸ì¸
  // ===================================================

  // ğŸš¨ ì£¼ì˜: ì‹¤ì œ íšŒì›ê°€ì… DTO(AuthRegisterRequest)ì— ë§ê²Œ í•„ë“œëª…ì„ í™•ì¸í•˜ì„¸ìš”.
  async function registerUser() {
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const nickname = document.getElementById('regNickname').value;
    const phoneNumber = document.getElementById('regPhoneNumber').value;
    const role = document.getElementById('regRole').value;

    const registerEndpoint = '/auth/sign-up';

    try {
      const response = await fetch(`${BASE_URL}${registerEndpoint}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email: email,
          password: password,
          nickname: nickname,
          phoneNumber: phoneNumber,
          role: role
        })
      });

      if (response.ok) {
        alert('íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ [ë¡œê·¸ì¸ & í† í° ì €ì¥]ì„ ì§„í–‰í•˜ì„¸ìš”.');
      } else {
        const errorData = await response.json();
        alert(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${errorData.message || response.statusText}`);
      }
    } catch (error) {
      console.error('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜:', error);
      alert('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    }
  }

  // ğŸš¨ ì£¼ì˜: ì‹¤ì œ ë¡œê·¸ì¸ DTO(AuthLoginRequest)ì— ë§ê²Œ í•„ë“œëª…ì„ í™•ì¸í•˜ì„¸ìš”.
  async function loginAndSaveToken() {

    // 1. role í•„ë“œ ê°’ì„ USERë¡œ ê°•ì œ ì„¤ì • (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
    document.getElementById('regRole').value = 'USER';

    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;

    // 2. ë¡œê·¸ì¸ í˜ì´ë¡œë“œì— role: 'USER'ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€ (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
    const loginPayload = {
      email: email,
      password: password,
      role: 'USER' // ì´ ê°’ì´ ì„œë²„ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
    };

    const loginEndpoint = '/auth/sign-in';

    try {
      const response = await fetch(`${BASE_URL}${loginEndpoint}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(loginPayload) // ìˆ˜ì •ëœ í˜ì´ë¡œë“œ ì „ì†¡
      });

      if (response.ok) {
        const data = await response.json();
        const jwtToken = data.accessToken || data.token;

        if (jwtToken) {
          localStorage.setItem(TOKEN_KEY, jwtToken);
          alert('ë¡œê·¸ì¸ ì„±ê³µ ë° í† í° ì €ì¥ ì™„ë£Œ!');
          updateTokenStatus();
        } else {
          throw new Error('ë¡œê·¸ì¸ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ì‘ë‹µì—ì„œ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      } else {
        const errorData = await response.json();
        alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${errorData.message || response.statusText}`);
      }
    } catch (error) {
      console.error('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜:', error);
      alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    }
  }

  // ğŸš¨ ì£¼ì˜: ì‹¤ì œ ì—…ë°ì´íŠ¸ DTOì— ë§ê²Œ í•„ë“œëª…ì„ í™•ì¸í•˜ì„¸ìš”. (ì˜ˆ: UserUpdateRequest)
  async function updateUserInfo() {
    const latitude = parseFloat(document.getElementById('latitude').value);
    const longitude = parseFloat(document.getElementById('longitude').value);

    const updateEndpoint = '/users/me'; // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ API ì£¼ì†Œë¡œ ê°€ì • (PATCH/PUT)

    const body = {
      latitude: latitude,
      longitude: longitude
    };

    const data = await apiCall(updateEndpoint, 'PATCH', body);

    const responseElement = document.getElementById('tokenStatus');
    if (data && !data.error) {
      alert('ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ ì„±ê³µ!');
      responseElement.textContent = JSON.stringify(data, null, 2);
    } else if (data) {
      alert(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${data.message}`);
      responseElement.textContent = JSON.stringify(data, null, 2);
    }
    updateTokenStatus();
  }

  // ===================================================
  // 2. ì£¼ë³€ ë§ˆíŠ¸ ì¡°íšŒ (GET /api/v1/stores)
  // ===================================================
  async function getNearbyStores() {
    const endpoint = '/stores';
    const responseElement = document.getElementById('nearbyStoresResponse');
    const data = await apiCall(endpoint);
    responseElement.textContent = JSON.stringify(data, null, 2);

    // ì¡°íšŒ ì„±ê³µ ì‹œ, ì²« ë²ˆì§¸ ë§ˆíŠ¸ IDë¥¼ ì…ë ¥ í•„ë“œì— ìë™ ì±„ìš°ê¸° (í¸ì˜ìƒ)
    if (data && data.stores && data.stores.length > 0) {
      document.getElementById('inputStoreId').value = data.stores[0].id;
    }
  }

  // ===================================================
  // 3. íŠ¹ì • ë§ˆíŠ¸ì˜ ìƒí’ˆ ì¡°íšŒ (GET /api/v1/sale-items/{storeId})
  // ===================================================
  async function getProductsByStore() {
    const storeId = document.getElementById('inputStoreId').value;
    if (!storeId) {
      alert('ë§ˆíŠ¸ IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì£¼ë³€ ë§ˆíŠ¸ ì¡°íšŒë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }
    const endpoint = `/sale-items/${storeId}`;
    const responseElement = document.getElementById('productsByStoreResponse');
    const data = await apiCall(endpoint);
    responseElement.textContent = JSON.stringify(data, null, 2);
  }

  // ===================================================
  // 4. ì£¼ë³€ ìƒí’ˆ ì¡°íšŒ (GET /api/v1/sale-items/nearby)
  // ===================================================
  async function getNearbySaleItems() {
    const endpoint = '/sale-items/nearby';
    const responseElement = document.getElementById('nearbySaleItemsResponse');
    const data = await apiCall(endpoint);
    responseElement.textContent = JSON.stringify(data, null, 2);
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ìƒíƒœ ì—…ë°ì´íŠ¸
  window.onload = updateTokenStatus;
</script>
</body>
</html>